# Specification: Audit Logging

## ADDED Requirements

### Requirement: 记录所有管理员操作
系统必须记录所有管理员的操作，包括操作类型、操作对象、操作结果等信息。

#### Scenario: 记录学生账户创建
- **WHEN** 管理员创建学生账户
- **THEN** 系统记录审计日志：操作类型="创建学生账户"，操作对象="学号"，操作结果="成功"

#### Scenario: 记录学生账户修改
- **WHEN** 管理员修改学生信息
- **THEN** 系统记录审计日志：操作类型="修改学生信息"，操作对象="学号"，旧值和新值

#### Scenario: 记录学生账户封禁
- **WHEN** 管理员封禁学生账户
- **THEN** 系统记录审计日志：操作类型="封禁账户"，操作对象="学号"，封禁原因

#### Scenario: 记录注册申请批准
- **WHEN** 管理员批准注册申请
- **THEN** 系统记录审计日志：操作类型="批准注册"，操作对象="申请 ID"

#### Scenario: 记录注册申请拒绝
- **WHEN** 管理员拒绝注册申请
- **THEN** 系统记录审计日志：操作类型="拒绝注册"，操作对象="申请 ID"，拒绝原因

### Requirement: 记录系统关键事件
系统必须记录所有关键事件，包括登录、登出、配置修改等。

#### Scenario: 记录管理员登录
- **WHEN** 管理员成功登录
- **THEN** 系统记录审计日志：事件类型="管理员登录"，IP 地址，User-Agent

#### Scenario: 记录管理员登录失败
- **WHEN** 管理员登录失败
- **THEN** 系统记录审计日志：事件类型="登录失败"，失败原因（密码错误/账户不存在），IP 地址

#### Scenario: 记录管理员登出
- **WHEN** 管理员登出
- **THEN** 系统记录审计日志：事件类型="管理员登出"

#### Scenario: 记录系统配置修改
- **WHEN** 超���管理员修改系统配置
- **THEN** 系统记录审计日志：事件类型="配置修改"，配置项名称，旧值和新值

### Requirement: 审计日志不可篡改
系统必须确保审计日志不可被篡改或删除，即使是超级管理员也无法修改。

#### Scenario: 审计日志仅支持追加
- **WHEN** 系统写入审计日志
- **THEN** 系统使用仅追加模式，不允许修改或删除已有日志

#### Scenario: 审计日志完整性校验
- **WHEN** 系统写入审计日志
- **THEN** 系统计算日志的哈希值，存储在独立的完整性表中

#### Scenario: 检测审计日志篡改
- **WHEN** 系统定期校验审计日志完整性
- **THEN** 系统重新计算哈希值，与存储的哈希值对比，如果不匹配则触发告警

### Requirement: 审计日志包含完整上下文
系统必须在审计日志中记录完整的操作上下文，支持事后追溯。

#### Scenario: 记录操作人信息
- **WHEN** 系统记录审计日志
- **THEN** 系统记录操作人的管理员 ID、用户名、角色

#### Scenario: 记录操作时间
- **WHEN** 系统记录审计日志
- **THEN** 系统记录操作的精确时间戳（UTC 时区）

#### Scenario: 记录操作来源
- **WHEN** 系统记录审计日志
- **THEN** 系统记录操作的 IP 地址、User-Agent、会话 ID

#### Scenario: 记录操作对象
- **WHEN** 系统记录审计日志
- **THEN** 系统记录操作对象的类型（学生账户/注册申请/系统配置等）和 ID

#### Scenario: 记录操作结果
- **WHEN** 系统记录审计日志
- **THEN** 系统记录操作结果（成功/失败）和错误消息（如果失败）

### Requirement: 审计日志支持高效查询
系统必须支持对审计日志的高效查询，包括时间范围、操作类型、操作人等维度。

#### Scenario: 按时间范围查询
- **WHEN** 管理员选择时间范围（如"最近 7 天"）
- **THEN** 系统返回该时间范围内的所有审计日志

#### Scenario: 按操作类型查询
- **WHEN** 管理员选择操作类型（如"封禁账户"）
- **THEN** 系统返回所有该类型的审计日志

#### Scenario: 按操作人查询
- **WHEN** 管理员选择操作人（如"admin001"）
- **THEN** 系统返回该管理员的所有操作记录

#### Scenario: 按操作对象查询
- **WHEN** 管理员输入操作对象 ID（如学号"2024CS0001"）
- **THEN** 系统返回所有涉及该对象的审计日志

#### Scenario: 组合条件查询
- **WHEN** 管理员同时选择时间范围、操作类型和操作人
- **THEN** 系统返回满足所有条件的审计日志

### Requirement: 审计日志支持导出
系统必须支持将审计日志导出为 CSV 或 JSON 格式，用于合规审查或分析。

#### Scenario: 导出为 CSV
- **WHEN** 管理员选择导出格式为 CSV
- **THEN** 系统生成包含所有字段的 CSV 文件

#### Scenario: 导出为 JSON
- **WHEN** 管理员选择导出格式为 JSON
- **THEN** 系统生成包含所有字段的 JSON 文件

#### Scenario: 导出指定时间范围的日志
- **WHEN** 管理员选择时间范围并导出
- **THEN** 系统仅导出该时间范围内的审计日志

### Requirement: 审计日志保留策略
系统必须实现审计日志的保留策略，符合 GDPR 和波兰教育法要求。

#### Scenario: 审计日志保留 5 年
- **WHEN** 系统记录审计日志
- **THEN** 系统保留日志 5 年，5 年后自动归档或删除

#### Scenario: 学生毕业后审计日志处理
- **WHEN** 学生毕业或退学
- **THEN** 系统将该学生相关的审计日志中的可识别信息替换为散列值，保留审计事件

#### Scenario: GDPR 删除请求处理
- **WHEN** 学生请求删除个人数据
- **THEN** 系统删除学生的可识别数据，但保留审计日志中的不可识别主键和散列值

### Requirement: 审计日志告警机制
系统必须实现审计日志的告警机制，检测异常操作并通知管理员。

#### Scenario: 检测批量封禁操作
- **WHEN** 某个管理员在 1 小时内封禁超过 10 个学生账户
- **THEN** 系统触发告警，通知超级管理员

#### Scenario: 检测异常登录
- **WHEN** 某个管理员从不同 IP 地址在短时间内多次登录
- **THEN** 系统触发告警，通知超级管理员

#### Scenario: 检测配置修改
- **WHEN** 超级管理员修改关键系统配置
- **THEN** 系统触发告警，通知所有超级管理员

#### Scenario: 检测审计日志篡改
- **WHEN** 系统检测到审计日志完整性校验失败
- **THEN** 系统触发紧急告警，通知所有超级管理员

### Requirement: 审计日志与 Elasticsearch 集成
系统必须将审计日志同步到 Elasticsearch，支持全文检索和复杂查询。

#### Scenario: 实时同步审计日志
- **WHEN** 系统记录审计日志到 MySQL
- **THEN** 系统异步同步日志到 Elasticsearch

#### Scenario: 全文检索审计日志
- **WHEN** 管理员输入搜索关键词（如"封禁"）
- **THEN** 系统在 Elasticsearch 中搜索，返回包含该关键词的所有审计日志

#### Scenario: 复杂查询审计日志
- **WHEN** 管理员使用复杂查询条件（如"操作类型=封禁 AND 操作人=admin001 AND 时间范围=最近 7 天"）
- **THEN** 系统在 Elasticsearch 中执行查询，返回匹配结果

### Requirement: 审计日志性能优化
系统必须优化审计日志的写入和查询性能，确保不影响主业务流程。

#### Scenario: 异步写入审计日志
- **WHEN** 系统记录审计日志
- **THEN** 系统使用异步队列（Kafka/NATS）写入日志，不阻塞主业务流程

#### Scenario: 批量写入审计日志
- **WHEN** 系统积累一定数量的审计日志（如 100 条）
- **THEN** 系统批量写入数据库，提升写入性能

#### Scenario: 分区表存储审计日志
- **WHEN** 系统存储审计日志
- **THEN** 系统使用按月分区的表，提升查询性能

#### Scenario: 冷热数据分离
- **WHEN** 审计日志超过 30 天
- **THEN** 系统将日志迁移到冷存储（如 S3），释放数据库空间
