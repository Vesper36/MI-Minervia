# Specification: Identity Generation

## ADDED Requirements

### Requirement: 规则引擎生成结构化字段
系统必须使用规则引擎根据用户选择的国家和身份类型生成结构化的身份信息字段。

**CONSTRAINT [ACADEMIC-YEAR-AUTO]**: 学年自动切换:
- 当前日期 < 9月1日: 使用下一学年
- 当前日期 >= 9月1日: 使用当前学年

**CONSTRAINT [STUDENT-ID-ATOMIC]**: 学号通过 `SELECT ... FOR UPDATE` + 唯一索引生成

**PBT [PBT-01]**: 学号全局唯一，格式{year}{faculty}{seq}
**PBT [PBT-02]**: 入学时18-25岁，birthDate < admissionDate < enrollmentDate
**PBT [PBT-03]**: LOCAL->PL+波兰姓名; INTERNATIONAL->国家匹配姓名

#### Scenario: 生成符合国家文化的姓名
- **WHEN** 系统为中国国际生生成姓名
- **THEN** 系统从中文姓名库中随机选择姓氏和名字，格式为"姓+名"（如"张伟"）

#### Scenario: 生成符合波兰文化的姓名
- **WHEN** 系统为波兰本地人生成姓名
- **THEN** 系统从波兰姓名库中随机选择姓氏和名字，格式为"名+姓"（如"Jan Kowalski"）

#### Scenario: 生成合理的出生日期
- **WHEN** 系统为本科生生成出生日期
- **THEN** 系统计算当前年份减去 18-25 岁，生成合理的出生日期范围

#### Scenario: 生成学号
- **WHEN** 系统生成学号
- **THEN** 系统按照格式 `{入学年份}{学院代码}{4位序号}` 生成唯一学号（如"2024CS0001"）

#### Scenario: 生成入学和录取时间
- **WHEN** 系统生成时间线
- **THEN** 系统确保录取日期早于入学日期，入学日期为当前学年的 9 月 1 日

### Requirement: 约束校验确保逻辑一致性
系统必须对生成的所有身份信息进行约束校验，确保逻辑自洽无矛盾。

#### Scenario: 年龄与学籍一致性校验
- **WHEN** 系统生成本科生身份信息
- **THEN** 系统验证年龄在 18-25 岁范围内，否则重新生成

#### Scenario: 时间线一致性校验
- **WHEN** 系统生成时间线
- **THEN** 系统验证录取日期 < 入学日期 < 当前日期，否则重新生成

#### Scenario: 专业与学院一致性校��
- **WHEN** 系统生成学号
- **THEN** 系统验证学院代码与用户选择的专业匹配，否则报错

#### Scenario: 学号唯一性校验
- **WHEN** 系统生成学号
- **THEN** 系统查询数据库确保学号唯一，如果重复则递增序号重新生成

### Requirement: LLM 润色自然语言描述
系统必须使用 LLM 生成自然语言描述，增强身份信息的真实感和多样性。

#### Scenario: 生成家庭背景描述
- **WHEN** 系统调用 LLM 生成家庭背景
- **THEN** 系统生成 2-3 句话的家庭背景描述，符合用户选择的国家文化

#### Scenario: 生成个人兴趣爱好
- **WHEN** 系统调用 LLM 生成兴趣爱好
- **THEN** 系统生成 1-2 句话的兴趣爱好描述，与用户选择的专业相关

#### Scenario: 生成学术目标
- **WHEN** 系统调用 LLM 生成学术目标
- **THEN** 系统生成 1-2 句话的学术目标描述，与用户选择的专业相关

#### Scenario: LLM 生成失败降级
- **WHEN** LLM 调用超时或失败
- **THEN** 系统使用预设模板生成通用描述，不阻塞整个流程

### Requirement: 生成数据标记和可追溯性
系统必须为所有生成的身份信息添加"模拟/测试"标记，并保留生成版本以支持审计。

**PBT [PBT-DETERMINISM] 生成确定性**:
- INVARIANT: 给定固定种子和配置(Country, Gender, Year)，生成器总是产生完全相同的身份
- FALSIFICATION: 用相同种子运行两次，断言任何字段差异即为违规
- BOUNDARY: Seed=0, Seed=MaxInt, 混合locale配置

#### Scenario: 添加模拟标记
- **WHEN** 系统生成身份信息
- **THEN** 系统在数据库中添加 `is_simulated=true` 标记

#### Scenario: 记录生成种子
- **WHEN** 系统生成身份信息
- **THEN** 系统记录随机种子和生成参数，支持可复现生成

#### Scenario: 记录生成版本
- **WHEN** 系统生成身份信息
- **THEN** 系统记录生成算法版本号和时间戳，支���审计追踪

### Requirement: 生成完整的学习时���线
系统必须生成详尽的在校学习时间线，包括入学、学期、课程等信息。

#### Scenario: 生成学期设定
- **WHEN** 系统生成学习时间线
- **THEN** 系统按照波兰学期制度生成秋季学期（9月-1月）和春季学期（2月-6月）

#### Scenario: 生成课程列表
- **WHEN** 系统生成学习时间线
- **THEN** 系统根据用户选择的专业生成每学期的课程列表（5-7 门课程）

#### Scenario: 生成成绩记录
- **WHEN** 系统生成学习时间线
- **THEN** 系统为每门课程生成合理的成绩（2.0-5.0 分，波兰评分制度）

#### Scenario: 生成 GPA
- **WHEN** 系统��成学习时间线
- **THEN** 系统计算所有课程的平均成绩作为 GPA

### Requirement: 生成家庭信息
系统必须生成符合逻辑的家庭信息，包括父母姓名、职业等。

#### Scenario: 生成父母姓名
- **WHEN** 系统生成家庭信息
- **THEN** 系统根据学生国籍生成符合文化的父母姓名

#### Scenario: 生成父母职业
- **WHEN** 系统生成家庭信息
- **THEN** 系统从职业列表中随机选择父母职业（如教师、工程师、医生等）

#### Scenario: 生成家庭地址
- **WHEN** 系统生成家庭信息
- **THEN** 系统根���学生国籍生成符合格式的家庭地址

### Requirement: 防止与真实人物相似
系统必须实现机制防止生成的身份信息与真实人物过于相似。

#### Scenario: 姓名相似度检查
- **WHEN** 系统生成姓名
- **THEN** 系统检查姓名是否在"禁用姓名列表"中（如名人、政治人物），如果匹配则重新生成

#### Scenario: 身份证号格式化
- **WHEN** 系统生成身份证号（如果需要）
- **THEN** 系统使用明显的虚拟格式（如"SIM-XXXX-XXXX"），避免与真实身份证号冲突

### Requirement: 批量生成支持
系统必须支持批量生成多个学生身份信息，用于测试或演示。

**CONSTRAINT [BATCH-LIMIT]**: 单次批量生成最大100个。超过需分批次提交。

**CONSTRAINT [BATCH-ISOLATION]**: 批量生成中单个任务失败不阻塞其他任务。返回结构化批量结果摘要:
```json
{
  "total": 100,
  "succeeded": 97,
  "failed": 3,
  "failures": [{"index": 23, "error": "..."}, ...]
}
```

#### Scenario: 批量生成请求
- **WHEN** 管理员请求批量生成 100 个学生身份
- **THEN** 系统创建 100 个异步任务，并行生成身份信息

#### Scenario: 批量生成进度跟踪
- **WHEN** 批量生成任务执行中
- **THEN** 系统显示进度条（如"已完成 50/100"）

#### Scenario: 批量生成失败处理
- **WHEN** 批量生成中某个任务失败
- **THEN** 系统记录失败原因，继续处理其他任务，最后汇总失败列表

### Requirement: 生成数据导出
系统必须支持将生成的身份信息导出为 JSON 或 CSV 格式，用于备份或分析。

**CONSTRAINT [EXPORT-ACCESS-CONTROL]**: 导出功能仅限超级管理员。每次导出生成审计日志并使用短期签名URL（有效期1小时）。

#### Scenario: 导出为 JSON
- **WHEN** 管理员选择导出格式为 JSON
- **THEN** 系统生成包含所有字段的 JSON 文件

#### Scenario: 导出为 CSV
- **WHEN** 管理员选择导出格式为 CSV
- **THEN** 系统生成包含主要字段的 CSV 文件（姓名、学号、专业、入学日期等）

#### Scenario: 导出包含敏感信息警告
- **WHEN** 管理员导出身份信息
- **THEN** 系统显示警告"导出文件包含敏感信息，请妥善保管"
